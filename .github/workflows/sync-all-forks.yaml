- name: Sync arpc-ndsu/arpcFCIP by pushing a sync branch + PR
  env:
    GH_TOKEN: ${{ secrets.ARPC_SYNC_TOKEN }}
    FORK: arpc-ndsu/arpcFCIP
    UPSTREAM: ftsiboe/arpcFCIP
    BASE: main
    SYNC_BRANCH: sync/upstream-main
  run: |
    set -euo pipefail

    gh auth status

    # Verify token can read both repos (important)
    gh api "repos/${FORK}" --jq '{full_name, private, permissions}'
    gh api "repos/${UPSTREAM}" --jq '{full_name, private}'

    # Checkout fork
    gh repo clone "${FORK}" repo
    cd repo

    git config user.name  "github-actions[bot]"
    git config user.email "github-actions[bot]@users.noreply.github.com"

    # Add upstream + fetch
    git remote add upstream "https://github.com/${UPSTREAM}.git"
    git fetch upstream "${BASE}"

    # Create/update sync branch from upstream/base
    git checkout -B "${SYNC_BRANCH}" "upstream/${BASE}"

    # Push sync branch to fork
    git push -u origin "${SYNC_BRANCH}" --force-with-lease

    # Create PR in fork from SYNC_BRANCH -> BASE (REST)
    title="Sync ${BASE} from ${UPSTREAM}"
    existing="$(gh api "repos/${FORK}/pulls?state=open&base=${BASE}&per_page=100" \
      --jq '.[] | select(.head.ref=="'"${SYNC_BRANCH}"'") | .number' | head -n 1 || true)"

    if [ -n "${existing:-}" ]; then
      echo "PR already open: #$existing"
      exit 0
    fi

    gh api -X POST "repos/${FORK}/pulls" \
      -f "title=${title}" \
      -f "head=${SYNC_BRANCH}" \
      -f "base=${BASE}" \
      -f "body=Automated sync PR created by controller workflow."
