name: Sync collaborator forks

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "If true, only prints what would be synced"
        required: false
        default: "true"
      include_private:
        description: "If true, include private repos (token must have access)"
        required: false
        default: "true"
      verbose:
        description: "If true, prints skip reasons"
        required: false
        default: "false"
  schedule:
    - cron: "30 6 * * 1" # Mondays 06:30 UTC

permissions:
  contents: read

concurrency:
  group: sync-collaborator-forks
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Verify token
        env:
          GH_TOKEN: ${{ secrets.ARPC_SYNC_TOKEN }}
        run: |
          set -euo pipefail
          gh auth status

      - name: Sync forks where arpc-ndsu is collaborator
        env:
          GH_TOKEN: ${{ secrets.ARPC_SYNC_TOKEN }}
          DRY_RUN: ${{ inputs.dry_run || 'true' }}
          INCLUDE_PRIVATE: ${{ inputs.include_private || 'true' }}
          VERBOSE: ${{ inputs.verbose || 'false' }}
        run: |
          set -euo pipefail

          echo "Dry run: $DRY_RUN"
          echo "Include private: $INCLUDE_PRIVATE"
          echo "Verbose: $VERBOSE"
          echo

          # visibility filter for /user/repos
          # all = public+private you can access; public = only public
          if [ "$INCLUDE_PRIVATE" = "true" ]; then
            visibility="all"
          else
            visibility="public"
          fi

          page=1
          per_page=100

          scanned=0
          synced=0
          skipped=0
          failed=0

          while : ; do
            repos="$(gh api "user/repos?affiliation=collaborator&per_page=${per_page}&page=${page}&visibility=${visibility}&sort=updated")"
            count="$(echo "$repos" | jq 'length')"
            [ "$count" -eq 0 ] && break

            for repo in $(echo "$repos" | jq -c '.[]'); do
              scanned=$((scanned+1))

              full_name="$(echo "$repo" | jq -r '.full_name')"
              is_fork="$(echo "$repo" | jq -r '.fork')"
              archived="$(echo "$repo" | jq -r '.archived')"
              default_branch="$(echo "$repo" | jq -r '.default_branch')"

              if [ "$archived" = "true" ]; then
                skipped=$((skipped+1))
                [ "$VERBOSE" = "true" ] && echo "SKIP (archived): $full_name"
                continue
              fi

              if [ "$is_fork" != "true" ]; then
                skipped=$((skipped+1))
                [ "$VERBOSE" = "true" ] && echo "SKIP (not a fork): $full_name"
                continue
              fi

              parent="$(gh api "repos/${full_name}" --jq '.parent.full_name // empty' || true)"
              if [ -z "$parent" ]; then
                skipped=$((skipped+1))
                [ "$VERBOSE" = "true" ] && echo "SKIP (fork but no parent): $full_name"
                continue
              fi

              echo "SYNC: $full_name <= $parent (branch: $default_branch)"

              if [ "$DRY_RUN" = "true" ]; then
                continue
              fi

              if gh repo sync "$full_name" -b "$default_branch"; then
                synced=$((synced+1))
              else
                echo "FAILED: $full_name"
                failed=$((failed+1))
              fi
            done

            page=$((page+1))
          done

          echo
          echo "Summary:"
          echo "  Scanned: $scanned"
          echo "  Synced:  $synced"
          echo "  Skipped: $skipped"
          echo "  Failed:  $failed"

          if [ "$failed" -gt 0 ] && [ "$DRY_RUN" != "true" ]; then
            exit 1
          fi
