name: Sync arpc-ndsu/arpcFCIP

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  sync_one:
    runs-on: ubuntu-latest
    steps:
      - name: Sync main from upstream (merge-upstream) with REST PR fallback
        env:
          GH_TOKEN: ${{ secrets.ARPC_SYNC_TOKEN }}
          FORK: arpc-ndsu/arpcFCIP
          BRANCH: main
        run: |
          set -euo pipefail

          parent="$(gh api "repos/${FORK}" --jq '.parent.full_name // empty')"
          echo "Fork:   $FORK"
          echo "Parent: $parent"
          echo "Branch: $BRANCH"

          # 1) Try merge-upstream (UI "Sync fork")
          if gh api -X POST "repos/${FORK}/merge-upstream" -f "branch=${BRANCH}" >/dev/null; then
            echo "✅ merge-upstream succeeded"
            exit 0
          fi

          echo "⚠️ merge-upstream failed; trying PR fallback (REST)..."

          upstream_owner="${parent%%/*}"
          title="Sync ${BRANCH} from ${parent}"

          # 2) Check existing open PRs via REST (no GraphQL)
          existing="$(gh api "repos/${FORK}/pulls?state=open&base=${BRANCH}&per_page=100" \
            --jq '.[] | select(.title=="'"$title"'") | .number' | head -n 1 || true)"

          if [ -n "${existing:-}" ]; then
            echo "PR already open: #$existing"
            exit 0
          fi

          # 3) Create PR via REST
          gh api -X POST "repos/${FORK}/pulls" \
            -f "title=${title}" \
            -f "head=${upstream_owner}:${BRANCH}" \
            -f "base=${BRANCH}" \
            -f "body=Automated sync PR because merge-upstream was blocked or conflicted."

          echo "✅ PR created"
