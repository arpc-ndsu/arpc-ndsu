name: Sync all forks from upstream

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "If true, only prints what would be synced"
        required: false
        default: "true"
      verbose:
        description: "If true, print per-repo decisions"
        required: false
        default: "false"
  schedule:
    - cron: "30 6 * * 1" # Mondays 06:30 UTC

permissions:
  contents: read

concurrency:
  group: sync-all-forks
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Verify token
        env:
          GH_TOKEN: ${{ secrets.ARPC_SYNC_TOKEN }}
        run: |
          set -euo pipefail
          gh auth status

      - name: Sync all forks owned by arpc-ndsu
        env:
          GH_TOKEN: ${{ secrets.ARPC_SYNC_TOKEN }}
          OWNER: arpc-ndsu
          DRY_RUN: ${{ inputs.dry_run || 'true' }}
          VERBOSE: ${{ inputs.verbose || 'false' }}
        run: |
          set -euo pipefail

          echo "Owner: $OWNER"
          echo "Dry run: $DRY_RUN"
          echo "Verbose: $VERBOSE"
          echo

          page=1
          per_page=100
          scanned=0
          synced=0
          skipped=0
          failed=0

          while : ; do
            repos="$(gh api "users/${OWNER}/repos?per_page=${per_page}&page=${page}&type=owner&sort=updated")"
            count="$(echo "$repos" | jq 'length')"
            [ "$count" -eq 0 ] && break

            # Iterate WITHOUT a pipe so counters persist
            for repo in $(echo "$repos" | jq -c '.[]'); do
              scanned=$((scanned+1))

              full_name="$(echo "$repo" | jq -r '.full_name')"
              is_fork="$(echo "$repo" | jq -r '.fork')"
              archived="$(echo "$repo" | jq -r '.archived')"
              default_branch="$(echo "$repo" | jq -r '.default_branch')"

              if [ "$is_fork" != "true" ]; then
                skipped=$((skipped+1))
                if [ "$VERBOSE" = "true" ]; then
                  echo "SKIP (not a fork): $full_name"
                fi
                continue
              fi

              if [ "$archived" = "true" ]; then
                skipped=$((skipped+1))
                if [ "$VERBOSE" = "true" ]; then
                  echo "SKIP (archived): $full_name"
                fi
                continue
              fi

              parent="$(gh api "repos/${full_name}" --jq '.parent.full_name // empty' || true)"
              if [ -z "$parent" ]; then
                skipped=$((skipped+1))
                echo "SKIP (fork but no parent): $full_name"
                continue
              fi

              echo "SYNC: $full_name  <=  $parent  (branch: $default_branch)"

              if [ "$DRY_RUN" = "true" ]; then
                continue
              fi

              if gh repo sync "$full_name" -b "$default_branch"; then
                synced=$((synced+1))
              else
                echo "FAILED: $full_name"
                failed=$((failed+1))
              fi
            done

            page=$((page+1))
          done

          echo
          echo "Summary:"
          echo "  Scanned: $scanned"
          echo "  Synced:  $synced"
          echo "  Skipped: $skipped"
          echo "  Failed:  $failed"

          if [ "$failed" -gt 0 ] && [ "$DRY_RUN" != "true" ]; then
            exit 1
          fi
