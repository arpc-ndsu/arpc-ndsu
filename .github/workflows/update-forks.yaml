name: Sync fork with upstream

on:
  schedule:
    - cron: "0 6 * * 1"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Sync via GitHub API (gh repo sync)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          # Detect default branch (main/master/etc.)
          DEFAULT_BRANCH="$(gh api "repos/${REPO}" --jq '.default_branch')"
          echo "Default branch: $DEFAULT_BRANCH"

          # If not a fork, parent will be empty; skip safely
          PARENT="$(gh api "repos/${REPO}" --jq '.parent.full_name // empty')"
          if [ -z "$PARENT" ]; then
            echo "Not a fork. Nothing to sync."
            exit 0
          fi
          echo "Upstream parent: $PARENT"

          # Sync fork from its parent on default branch
          gh repo sync "${REPO}" -b "${DEFAULT_BRANCH}"
